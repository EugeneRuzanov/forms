<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
	<link rel="stylesheet" href="foundation-5.5.2/css/foundation.min.css">
	<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="dropzone">
	<div class="dropzone-message">Drop files there</div>
</div>
<div class="main-container">
	<form action="#" class="from-container">
		<label>
			Address
			<input type="text" name="address">
		</label>
		<label for="price">Price</label>
		<div class="row collapse">
			<div class="columns medium-2">
				<span class="prefix">&pound;</span>
			</div>
			<div class="columns medium-10">
				<input type="text" id="price" name="price">
			</div>
		</div>
		<label>
			Description
			<textarea name="description"></textarea>
		</label>

		<button type="submit" class="small">Send</button>
	</form>
	<div class="images-container">
		<div class="toolbar">
			<div class="toolbar-info"></div>
			<div class="toolbar-actions">
				<a href="#main">Main</a>
				<a href="#publish">Publish</a>
				<a href="#delete">Delete</a>
			</div>
		</div>
		<ul class="sortable"></ul>
	</div>
</div>
<script src="js/FileAPI.html5.js"></script>
<script src="js/Sortable.js"></script>
<script>
	(function () {
		var _files = {},
			dropzone = document.querySelector( '.dropzone'),
			imagesContainer = document.querySelector( '.images-container .sortable'),
			toolBarInfo = document.querySelector( '.toolbar-info'),
			clickSelect = function () {
				if ( !this.classList.contains( 'selected' ) ) {
					this.classList.add( 'selected' );
					//todo save to selected
					_files[getIndex( this )].selected = true;
				} else {
					this.classList.remove( 'selected' );
					//todo remove to selected
					_files[getIndex( this )].selected = false;
				}
				setToolBarInfo();
			},
			getIndex = function ( domEl ) {
				return Object.keys( _files ).filter(function ( k ) { return _files[k].dom === domEl; } )[0];
			},
			setToolBarInfo = function () {
				var keys = Object.keys( _files );
				toolBarInfo.innerHTML = 'Total: ' + keys.length;
				toolBarInfo.innerHTML += ' / Selected: ' + keys.filter( function( i ) { return _files[i].selected; } ).length;
			},
			onHover = function ( hover ) {
				dropzone.classList[ hover ? 'add' : 'remove' ]( 'show' );
			},
			onFile = function ( files ) {
				FileAPI.each( files, function ( file ) {
					FileAPI.Image( file ).get( function (err/**String*/, img/**HTMLElement*/) {
						var li;
						if ( !err ) {
							li = document.createElement( 'li' );
							_files[FileAPI.uid()] = { img : file, dom: li, selected : false, main : false, publish : false };
							setToolBarInfo();
							li.addEventListener( 'click', clickSelect );
							li.appendChild( img );
							imagesContainer.appendChild( li );
						}
					});
				});
			};

		new Sortable( document.querySelector( '.sortable' ), {
			onUpdate : function ( e ) {
				//todo send order to server
				console.log( 'onUpdate:', e );
			}
		} );

		setToolBarInfo();

		FileAPI.event.dnd( document, onHover, onFile );

	} )();
</script>
</body>
</html>
